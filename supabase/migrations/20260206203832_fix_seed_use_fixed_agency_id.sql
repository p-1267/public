/*
  # Fix Seed to Use Fixed Agency ID
  
  Update seed function to create agency with fixed ID matching mockAgencyId in ShowcaseContext.
*/

CREATE OR REPLACE FUNCTION seed_senior_family_scenario()
RETURNS jsonb
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_agency_id uuid := 'a0000000-0000-0000-0000-000000000010'::uuid;  -- Fixed showcase agency ID
  v_senior_user_id uuid := 'a0000000-0000-0000-0000-000000000001'::uuid;
  v_family_user_id uuid := 'a0000000-0000-0000-0000-000000000002'::uuid;
  v_caregiver1_id uuid := 'a0000000-0000-0000-0000-000000000003'::uuid;
  v_caregiver2_id uuid := 'a0000000-0000-0000-0000-000000000004'::uuid;
  v_supervisor_id uuid := 'a0000000-0000-0000-0000-000000000005'::uuid;
  v_resident_id uuid := 'b0000000-0000-0000-0000-000000000001'::uuid;
  v_nursing_dept_id uuid;
  v_housekeeping_dept_id uuid;
  v_dietary_dept_id uuid;
  v_device_id uuid;
  v_result jsonb;
BEGIN
  DELETE FROM health_metrics WHERE resident_id = v_resident_id;
  DELETE FROM device_registry WHERE resident_id = v_resident_id;
  DELETE FROM resident_emergency_contacts WHERE resident_id = v_resident_id;
  DELETE FROM lab_tests WHERE resident_id = v_resident_id;
  DELETE FROM appointments WHERE resident_id = v_resident_id;
  DELETE FROM resident_medications WHERE resident_id = v_resident_id;
  DELETE FROM tasks WHERE resident_id = v_resident_id;
  DELETE FROM task_categories WHERE agency_id = v_agency_id;
  DELETE FROM department_personnel WHERE agency_id = v_agency_id;
  DELETE FROM departments WHERE agency_id = v_agency_id;
  DELETE FROM senior_resident_links WHERE senior_user_id = v_senior_user_id;
  DELETE FROM family_resident_links WHERE family_user_id = v_family_user_id;
  DELETE FROM caregiver_assignments WHERE resident_id = v_resident_id;
  DELETE FROM residents WHERE id = v_resident_id;
  DELETE FROM user_profiles WHERE id IN (v_senior_user_id, v_family_user_id, v_caregiver1_id, v_caregiver2_id, v_supervisor_id);
  DELETE FROM agencies WHERE id = v_agency_id;

  -- Create agency with fixed ID
  INSERT INTO agencies (id, name, status, operating_mode, metadata) 
  VALUES (v_agency_id, 'Showcase Care Agency', 'active', 'AGENCY', jsonb_build_object('type', 'HOME_HEALTH', 'phone', '555-0100', 'email', 'info@showcasecare.com', 'address', '123 Demo St'));

  INSERT INTO user_profiles (id, agency_id, role_id, display_name, is_active) VALUES (v_supervisor_id, v_agency_id, (SELECT id FROM roles WHERE name = 'SUPERVISOR'), 'Sarah Johnson', true), (v_caregiver1_id, v_agency_id, (SELECT id FROM roles WHERE name = 'CAREGIVER'), 'Mike Chen', true), (v_caregiver2_id, v_agency_id, (SELECT id FROM roles WHERE name = 'CAREGIVER'), 'Lisa Martinez', true), (v_senior_user_id, v_agency_id, (SELECT id FROM roles WHERE name = 'SENIOR'), 'Dorothy Miller', true), (v_family_user_id, v_agency_id, (SELECT id FROM roles WHERE name = 'FAMILY_ADMIN'), 'Robert Miller', true);
  INSERT INTO residents (id, agency_id, full_name, date_of_birth, status, metadata) VALUES (v_resident_id, v_agency_id, 'Dorothy Miller', '1945-03-15', 'active', jsonb_build_object('room', '101A', 'care_level', 'ASSISTED_LIVING'));
  INSERT INTO senior_resident_links (senior_user_id, resident_id, status) VALUES (v_senior_user_id, v_resident_id, 'active');
  INSERT INTO family_resident_links (family_user_id, resident_id, status) VALUES (v_family_user_id, v_resident_id, 'active');
  INSERT INTO caregiver_assignments (agency_id, caregiver_user_id, resident_id, assigned_by, status, metadata) VALUES (v_agency_id, v_caregiver1_id, v_resident_id, v_supervisor_id, 'active', '{"is_primary": true}'::jsonb);
  INSERT INTO departments (agency_id, name, department_code, description, status, icon, staff_count) VALUES (v_agency_id, 'Nursing', 'NURSING', 'Medical care', 'normal', 'üíä', 3), (v_agency_id, 'Housekeeping', 'HOUSEKEEPING', 'Cleaning', 'normal', 'üßπ', 1), (v_agency_id, 'Dietary', 'DIETARY', 'Meals', 'normal', 'üçΩÔ∏è', 0);
  SELECT id INTO v_nursing_dept_id FROM departments WHERE agency_id = v_agency_id AND department_code = 'NURSING';
  SELECT id INTO v_housekeeping_dept_id FROM departments WHERE agency_id = v_agency_id AND department_code = 'HOUSEKEEPING';
  SELECT id INTO v_dietary_dept_id FROM departments WHERE agency_id = v_agency_id AND department_code = 'DIETARY';
  INSERT INTO department_personnel (department_id, user_id, agency_id, employee_id, position_title, shift_pattern, status, first_name, last_name, display_name, skills, is_primary_department, work_phone, work_email, workload_indicator) VALUES (v_nursing_dept_id, v_supervisor_id, v_agency_id, 'EMP001', 'Nursing Supervisor', 'day', 'on_shift', 'Sarah', 'Johnson', 'Sarah Johnson', ARRAY['supervision'], true, '555-0101', 'sarah@showcasecare.com', 2), (v_nursing_dept_id, v_caregiver1_id, v_agency_id, 'EMP002', 'Registered Nurse', 'day', 'on_shift', 'Mike', 'Chen', 'Mike Chen', ARRAY['medication_administration'], true, '555-0102', 'mike@showcasecare.com', 3), (v_housekeeping_dept_id, v_caregiver2_id, v_agency_id, 'EMP003', 'Housekeeper', 'day', 'on_shift', 'Lisa', 'Martinez', 'Lisa Martinez', ARRAY['cleaning'], true, '555-0103', 'lisa@showcasecare.com', 3);
  INSERT INTO task_categories (agency_id, name, category_type, description, default_priority, default_risk_level, requires_evidence, allows_skip, is_active, sort_order, metadata) VALUES (v_agency_id, 'Medication Administration', 'clinical', 'Administer medications', 'high', 'A', true, false, true, 1, jsonb_build_object('department_id', v_nursing_dept_id)), (v_agency_id, 'Vital Signs Check', 'monitoring', 'Check vital signs', 'medium', 'B', true, false, true, 2, jsonb_build_object('department_id', v_nursing_dept_id)), (v_agency_id, 'Room Cleaning', 'housekeeping', 'Clean rooms', 'medium', 'C', false, false, true, 3, jsonb_build_object('department_id', v_housekeeping_dept_id)), (v_agency_id, 'Meal Service', 'nutrition', 'Deliver meals', 'medium', 'B', false, false, true, 4, jsonb_build_object('department_id', v_dietary_dept_id)), (v_agency_id, 'Wellness Check', 'monitoring', 'Check wellbeing', 'low', 'B', false, false, true, 5, jsonb_build_object('department_id', v_nursing_dept_id));
  INSERT INTO tasks (agency_id, resident_id, category_id, department_id, department, task_name, description, scheduled_start, scheduled_end, priority, risk_level, state, responsibility_role, requires_evidence, is_recurring) SELECT v_agency_id, v_resident_id, (SELECT id FROM task_categories WHERE name = 'Medication Administration' AND agency_id = v_agency_id), v_nursing_dept_id, 'NURSING', 'Morning Medications', 'Meds', date_trunc('day', now()) + interval '8 hours', date_trunc('day', now()) + interval '9 hours', 'high', 'B', 'scheduled', 'RN', true, true UNION ALL SELECT v_agency_id, v_resident_id, (SELECT id FROM task_categories WHERE name = 'Vital Signs Check' AND agency_id = v_agency_id), v_nursing_dept_id, 'NURSING', 'Morning Vitals', 'Vitals', date_trunc('day', now()) + interval '9 hours', date_trunc('day', now()) + interval '10 hours', 'medium', 'B', 'scheduled', 'RN', true, true UNION ALL SELECT v_agency_id, v_resident_id, (SELECT id FROM task_categories WHERE name = 'Room Cleaning' AND agency_id = v_agency_id), v_housekeeping_dept_id, 'HOUSEKEEPING', 'Room Cleaning', 'Clean', date_trunc('day', now()) + interval '10 hours', date_trunc('day', now()) + interval '11 hours', 'low', 'B', 'scheduled', 'HOUSEKEEPER', false, true UNION ALL SELECT v_agency_id, v_resident_id, (SELECT id FROM task_categories WHERE name = 'Meal Service' AND agency_id = v_agency_id), v_dietary_dept_id, 'KITCHEN', 'Lunch', 'Lunch', date_trunc('day', now()) + interval '12 hours', date_trunc('day', now()) + interval '13 hours', 'medium', 'B', 'scheduled', 'KITCHEN_STAFF', false, true UNION ALL SELECT v_agency_id, v_resident_id, (SELECT id FROM task_categories WHERE name = 'Wellness Check' AND agency_id = v_agency_id), v_nursing_dept_id, 'NURSING', 'Afternoon Check', 'Check', date_trunc('day', now()) + interval '14 hours', date_trunc('day', now()) + interval '15 hours', 'low', 'B', 'scheduled', 'RN', false, true UNION ALL SELECT v_agency_id, v_resident_id, (SELECT id FROM task_categories WHERE name = 'Medication Administration' AND agency_id = v_agency_id), v_nursing_dept_id, 'NURSING', 'Evening Medications', 'Evening meds', date_trunc('day', now()) + interval '18 hours', date_trunc('day', now()) + interval '19 hours', 'high', 'B', 'scheduled', 'RN', true, true UNION ALL SELECT v_agency_id, v_resident_id, (SELECT id FROM task_categories WHERE name = 'Wellness Check' AND agency_id = v_agency_id), v_nursing_dept_id, 'NURSING', 'Bedtime Check', 'Bedtime', date_trunc('day', now()) + interval '20 hours', date_trunc('day', now()) + interval '21 hours', 'medium', 'B', 'scheduled', 'RN', false, true;
  INSERT INTO resident_medications (resident_id, medication_name, dosage, frequency, route, prescriber_name, start_date, is_active, special_instructions, entered_by, language_context) VALUES (v_resident_id, 'Lisinopril', '10mg', 'daily', 'ORAL', 'Dr. Smith', now() - interval '6 months', true, 'Take with morning meal', v_caregiver1_id, 'en'), (v_resident_id, 'Metformin', '500mg', 'twice_daily', 'ORAL', 'Dr. Smith', now() - interval '6 months', true, 'Take with meals', v_caregiver1_id, 'en');
  INSERT INTO appointments (resident_id, appointment_type, title, scheduled_at, duration_minutes, provider_name, location, status, notes, created_by) VALUES (v_resident_id, 'DOCTOR_VISIT', 'Routine Physical Examination', now() + interval '3 days', 30, 'Dr. Smith', 'Medical Center', 'SCHEDULED', 'Annual checkup', v_family_user_id), (v_resident_id, 'SCREENING', 'Quarterly Blood Work', now() + interval '7 days', 15, 'Lab Corp', 'Onsite Laboratory', 'SCHEDULED', 'Standard metabolic panel', v_caregiver1_id), (v_resident_id, 'DOCTOR_VISIT', 'Follow-up Visit', now() - interval '30 days', 30, 'Dr. Smith', 'Medical Center', 'COMPLETED', 'Previous checkup - all results normal', v_caregiver1_id);
  INSERT INTO lab_tests (resident_id, test_type, test_name, ordered_by, ordered_at, completed_at, status) VALUES (v_resident_id, 'BLOOD_WORK', 'Complete Blood Count', 'Dr. Smith', now() - interval '60 days', now() - interval '58 days', 'COMPLETED'), (v_resident_id, 'BLOOD_WORK', 'Metabolic Panel', 'Dr. Smith', now() - interval '60 days', now() - interval '58 days', 'COMPLETED');
  INSERT INTO resident_emergency_contacts (resident_id, contact_name, relationship, phone_primary, phone_secondary, email, is_primary, contact_order, entered_by, language_context) VALUES (v_resident_id, 'Robert Miller', 'son', '555-0202', NULL, 'robert@example.com', true, 1, v_family_user_id, 'en'), (v_resident_id, 'Susan Miller', 'daughter', '555-0203', NULL, 'susan@example.com', false, 2, v_family_user_id, 'en');
  INSERT INTO device_registry (device_id, resident_id, device_type, device_name, manufacturer, model, firmware_version, battery_level, trust_state, capabilities, pairing_actor, pairing_timestamp) VALUES ('OMRON-BP-' || substr(md5(v_resident_id::text), 1, 8), v_resident_id, 'BLE_HEALTH_SENSOR', 'OMRON Evolv', 'OMRON', 'BP7900', '2.1.4', 85, 'TRUSTED', '{"supported_metrics": ["blood_pressure_systolic", "blood_pressure_diastolic", "heart_rate"]}'::jsonb, v_senior_user_id, now() - interval '30 days') RETURNING id INTO v_device_id;
  INSERT INTO health_metrics (resident_id, device_registry_id, metric_category, metric_type, value_numeric, unit, confidence_level, measurement_source, recorded_at, data_source) SELECT v_resident_id, v_device_id, CASE WHEN metric_type IN ('blood_pressure_systolic', 'blood_pressure_diastolic') THEN 'BLOOD_PRESSURE' ELSE 'CARDIOVASCULAR' END, metric_type, value_numeric, unit, 'HIGH', 'AUTOMATIC_DEVICE', recorded_at, 'SEEDED' FROM ( SELECT 'blood_pressure_systolic' as metric_type, 125.0 as value_numeric, 'mmHg' as unit, now() - interval '6 days' + interval '8 hours' as recorded_at UNION ALL SELECT 'blood_pressure_diastolic', 78.0, 'mmHg', now() - interval '6 days' + interval '8 hours' UNION ALL SELECT 'heart_rate', 72.0, 'bpm', now() - interval '6 days' + interval '8 hours' UNION ALL SELECT 'blood_pressure_systolic', 128.0, 'mmHg', now() - interval '6 days' + interval '20 hours' UNION ALL SELECT 'blood_pressure_diastolic', 80.0, 'mmHg', now() - interval '6 days' + interval '20 hours' UNION ALL SELECT 'heart_rate', 75.0, 'bpm', now() - interval '6 days' + interval '20 hours' UNION ALL SELECT 'blood_pressure_systolic', 122.0, 'mmHg', now() - interval '5 days' + interval '8 hours' UNION ALL SELECT 'blood_pressure_diastolic', 76.0, 'mmHg', now() - interval '5 days' + interval '8 hours' UNION ALL SELECT 'heart_rate', 70.0, 'bpm', now() - interval '5 days' + interval '8 hours' UNION ALL SELECT 'blood_pressure_systolic', 130.0, 'mmHg', now() - interval '5 days' + interval '14 hours' UNION ALL SELECT 'blood_pressure_diastolic', 82.0, 'mmHg', now() - interval '5 days' + interval '14 hours' UNION ALL SELECT 'heart_rate', 74.0, 'bpm', now() - interval '5 days' + interval '14 hours' UNION ALL SELECT 'blood_pressure_systolic', 126.0, 'mmHg', now() - interval '5 days' + interval '20 hours' UNION ALL SELECT 'blood_pressure_diastolic', 79.0, 'mmHg', now() - interval '5 days' + interval '20 hours' UNION ALL SELECT 'heart_rate', 73.0, 'bpm', now() - interval '5 days' + interval '20 hours' UNION ALL SELECT 'blood_pressure_systolic', 124.0, 'mmHg', now() - interval '4 days' + interval '8 hours' UNION ALL SELECT 'blood_pressure_diastolic', 77.0, 'mmHg', now() - interval '4 days' + interval '8 hours' UNION ALL SELECT 'heart_rate', 71.0, 'bpm', now() - interval '4 days' + interval '8 hours' UNION ALL SELECT 'blood_pressure_systolic', 129.0, 'mmHg', now() - interval '4 days' + interval '20 hours' UNION ALL SELECT 'blood_pressure_diastolic', 81.0, 'mmHg', now() - interval '4 days' + interval '20 hours' UNION ALL SELECT 'heart_rate', 76.0, 'bpm', now() - interval '4 days' + interval '20 hours' UNION ALL SELECT 'blood_pressure_systolic', 123.0, 'mmHg', now() - interval '3 days' + interval '8 hours' UNION ALL SELECT 'blood_pressure_diastolic', 75.0, 'mmHg', now() - interval '3 days' + interval '8 hours' UNION ALL SELECT 'heart_rate', 69.0, 'bpm', now() - interval '3 days' + interval '8 hours' UNION ALL SELECT 'blood_pressure_systolic', 127.0, 'mmHg', now() - interval '2 days' + interval '8 hours' UNION ALL SELECT 'blood_pressure_diastolic', 78.0, 'mmHg', now() - interval '2 days' + interval '8 hours' UNION ALL SELECT 'heart_rate', 72.0, 'bpm', now() - interval '2 days' + interval '8 hours' UNION ALL SELECT 'blood_pressure_systolic', 131.0, 'mmHg', now() - interval '2 days' + interval '20 hours' UNION ALL SELECT 'blood_pressure_diastolic', 83.0, 'mmHg', now() - interval '2 days' + interval '20 hours' UNION ALL SELECT 'heart_rate', 77.0, 'bpm', now() - interval '2 days' + interval '20 hours' UNION ALL SELECT 'blood_pressure_systolic', 125.0, 'mmHg', now() - interval '1 day' + interval '8 hours' UNION ALL SELECT 'blood_pressure_diastolic', 79.0, 'mmHg', now() - interval '1 day' + interval '8 hours' UNION ALL SELECT 'heart_rate', 73.0, 'bpm', now() - interval '1 day' + interval '8 hours' ) metrics;

  v_result := jsonb_build_object('success', true, 'agency_id', v_agency_id, 'resident_id', v_resident_id, 'users_created', 5, 'tasks_created', 7, 'appointments_created', 3, 'lab_tests_created', 2, 'departments_created', 3, 'device_id', v_device_id, 'health_metrics_created', 33, 'medications_created', 2, 'emergency_contacts_created', 2, 'note', 'Senior/Family showcase scenario with FIXED agency ID');
  RETURN v_result;
END;
$$;
